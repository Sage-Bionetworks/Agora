sudo: required
dist: xenial
language: node_js
cache:
  npm: false

addons:
  chrome: stable

branches:
  only:
  - develop
  - staging
  - prod

before_install:
  - npm install npm@8.11.0
  - npm cache verify
  - travis_retry npm prune

install:
  - npm install

before_script:
  - export NODE_OPTIONS=--max_old_space_size=4096

stages:
  - name: test
  - name: eb-deploy-develop
    if: (tag =~ ^v) OR (type = push) AND (branch = develop)
  - name: eb-deploy-staging
    if: (tag =~ ^v) OR (type = push) AND (branch = staging)
  - name: eb-deploy-prod
    if: (tag =~ ^v) OR (type = push) AND (branch = prod)

jobs:
  fast_finish: true
  include:
    - stage: test
      script: npm run ci:travis
      node_js: 16
    - stage: eb-deploy-develop
      script:
        - ./set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          skip_cleanup: true
          bucket_name: org-sagebionetworks-agora-deployment-agora-$TRAVIS_BRANCH
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          local_dir: dist
          app: agora-ampad
          env:
            develop: agora-develop
            DISABLE_OPENCOLLECTIVE: true
          on:
            all_branches: true
          access_key_id: AKIAY22FMBNE7T3Q36PT
          secret_access_key:
            secure: "RkCI4mS/yRnMIZp+Wh++DN6gIIy1i1UDQ/V7Vml14pAH9BThurpDJPfEfFZW8twwavJkn5PjPvx4yg3D66o1UQTRGgAVXnYNLpKX9Vr6xhypCD8fNpMR0PVzZJl7JiRpsnWIyjkDbILyqRoF2ACg8IkHSx1gqVkBxMz1gC53DyA9O7rh/xAZvw4Hl/J2tKf+jQSA/Z3JIOWhyn19jkTzTSh5Y5MAX2kZJqDKIbmDaL3fIk/i507Us9mJMIjQVFuP6phtbylqsyuZUe8P2bvNEKrtDAlpNJQIIH6dzCS0KadXIL8LLl3XJ7+U75cB+iNbJFKKr82x2dHHYEQkTOVsdBsMtEDxZXV2TRpryWqG1OsFT11pg0v9OpK+Dhc3a2Oa8SbQQFIrJtYKw2QecQ0vsTaz4U7ro+X+ZUCxk/IneXUxPNOe1OPhBucLHbMoS/x5wvHwW0JzCBAQEEpnFQB9h68JkS5Q+MXvITuXEuly2EROyqPMi55sOkRHJrca1djMmUKqMIIg6yrINhwswth0OPvLsVM0BQRmDF/Ew+7XjbQD2uUvjiukpHjoF/93KRgz/B4ep1f91Kmg2gyu80EJVWWY+m3RWbuz00cO1vZAhvfc+McknsYlA1oSnunXe2MSi+JhO8WuZj5K9jWiI7O88RbXULVf3IJ9JbP+2UT5wu8="
    - stage: eb-deploy-staging
      script:
        - ./set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          skip_cleanup: true
          bucket_name: org-sagebionetworks-agora-deployment-agora-$TRAVIS_BRANCH
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          local_dir: dist
          app: agora-ampad
          env:
            staging: agora-staging
            DISABLE_OPENCOLLECTIVE: true
          on:
            all_branches: true
          access_key_id: AKIAZ5GJ3GCELHWLMUUX
          secret_access_key:
            secure: "ihn8trFXzyq6tAHnTuhiaiONmMDXp3HdgtOJmH+i7lkwUNimFd29qzinA4t4EVzS2waUXZQ6UOjadepg5Jnoa5iRzJL8X/8Y8Uf0SsjkST7AI8gMlDaEwWmnhkUuaeLOa5pLHj+SC4vG7R+vk4YWeuplNxcEHwIyzxTd+Ttk/hTfxdld94naoJUGaY9aj/SfyntVBFvkmUVyWONWfaMMJK+crFoVbQBPuQzUx53kBzHfpOdl9D65DntJ+ckiNbsG0Swb3kdjiCvBt7ytFMY1uTl0cBEC3S6n25gm5qSTGsl0/E6ZMpDbccd74leGb8EvjIeoMY65/kNwThwEFaKaAGfU59GeDPkX2uwZjOe8fs12UHjGafXCzkfY1PQ1LoE8QdE4Q88s3TANWa+MJi2+A5uLFtH5KdFYReTCPVWI0mmYU//7Vv9t/jKW3R8LLUd+NlL04UIeNU49sxCANuAzT8ON34clP9ausDcpi1taE95CRHFMQ1Uib+aMCXKTXhHy2zYatoxYbf7U8jGBMNV26bl7Y1d5mzNbLkZu+nPe2LOQhU3lmNyhmKaZI7P55ARmoTQqzTHqC8Zs6KwuLZxxVUotP+TA/3tYxuGLAKckcMM9CBJzIO/pq7YzvcXfJ/POUPo3Gu7sq01ItUGzI3LGxTkkg2GwLKEJzc+g9IBEvow="
    - stage: eb-deploy-prod
      script:
        - ./set-agora-version.sh || travis_terminate 1
        - zip /tmp/agora-app.zip -qr9 * .[^.]*
      node_js: 16
      deploy:
        - provider: elasticbeanstalk
          skip_cleanup: true
          bucket_name: org-sagebionetworks-agora-deployment-agora-$TRAVIS_BRANCH
          zip_file: /tmp/agora-app.zip
          region: us-east-1
          local_dir: dist
          app: agora-ampad
          env:
            prod: agora-prod
            DISABLE_OPENCOLLECTIVE: true
          on:
            all_branches: true
          access_key_id: AKIAZ5GJ3GCELHWLMUUX
          secret_access_key:
            secure: "ihn8trFXzyq6tAHnTuhiaiONmMDXp3HdgtOJmH+i7lkwUNimFd29qzinA4t4EVzS2waUXZQ6UOjadepg5Jnoa5iRzJL8X/8Y8Uf0SsjkST7AI8gMlDaEwWmnhkUuaeLOa5pLHj+SC4vG7R+vk4YWeuplNxcEHwIyzxTd+Ttk/hTfxdld94naoJUGaY9aj/SfyntVBFvkmUVyWONWfaMMJK+crFoVbQBPuQzUx53kBzHfpOdl9D65DntJ+ckiNbsG0Swb3kdjiCvBt7ytFMY1uTl0cBEC3S6n25gm5qSTGsl0/E6ZMpDbccd74leGb8EvjIeoMY65/kNwThwEFaKaAGfU59GeDPkX2uwZjOe8fs12UHjGafXCzkfY1PQ1LoE8QdE4Q88s3TANWa+MJi2+A5uLFtH5KdFYReTCPVWI0mmYU//7Vv9t/jKW3R8LLUd+NlL04UIeNU49sxCANuAzT8ON34clP9ausDcpi1taE95CRHFMQ1Uib+aMCXKTXhHy2zYatoxYbf7U8jGBMNV26bl7Y1d5mzNbLkZu+nPe2LOQhU3lmNyhmKaZI7P55ARmoTQqzTHqC8Zs6KwuLZxxVUotP+TA/3tYxuGLAKckcMM9CBJzIO/pq7YzvcXfJ/POUPo3Gu7sq01ItUGzI3LGxTkkg2GwLKEJzc+g9IBEvow="
